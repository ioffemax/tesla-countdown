<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket Tracker v6.1</title>
    <style>
        body {
            background-color: #000000;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Чтобы не было скролла */
            user-select: none;
        }

        #container { 
            text-align: center; 
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            position: relative;
            z-index: 1; /* Контент ниже версии */
        }

        /* Статус (вверху) */
        #top-status {
            font-size: 1rem;
            color: #777;
            margin-bottom: 10px;
            font-family: monospace;
            height: 1.5em;
        }

        /* ГЛАВНАЯ ЦИФРА ($1,XXX) */
        #payout-amount {
            font-size: 18vw; /* Адаптивный огромный размер */
            font-weight: 800;
            line-height: 1.1; 
            color: #4ade80;   /* Ярко-зеленый */
            text-shadow: 0 0 50px rgba(74, 222, 128, 0.25);
            margin: 10px 0 30px 0; /* Большой отступ снизу */
            letter-spacing: -3px;
        }

        /* Пояснение */
        .explanation {
            font-size: 1.6rem;
            color: #aaa;
            margin-bottom: 40px; 
            font-weight: 400;
        }

        /* Блок с деталями (Цена и Шанс) */
        .stats-row {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .stat-box {
            background: #111;
            border: 1px solid #333;
            padding: 15px 30px;
            border-radius: 15px;
            min-width: 140px;
        }

        .stat-val {
            display: block;
            font-size: 1.8rem;
            font-weight: bold;
            color: #fff;
        }

        .stat-lbl {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            margin-top: 5px;
            display: block;
            font-weight: 600;
        }

        /* ВЕРСИЯ - Сделана максимально заметной */
        .version {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 1.1rem;
            color: #ffffff;      /* Белый текст */
            background: #333333; /* Серый фон */
            padding: 8px 15px;
            border-radius: 8px;
            font-family: monospace;
            border: 2px solid #555; /* Рамка */
            z-index: 100; /* Поверх всего */
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* Сообщения об ошибках */
        #error-msg {
            color: #ff5555;
            margin-top: 25px;
            font-family: monospace;
            display: none;
            background: rgba(50,0,0,0.9);
            padding: 15px;
            border-radius: 8px;
            max-width: 80%;
            margin-left: auto;
            margin-right: auto;
        }

        .loading { opacity: 0.3; }
    </style>
</head>
<body>

    <div id="container">
        <div id="top-status">Запуск...</div>
        
        <div id="payout-amount" class="loading">---</div>
        
        <div class="explanation">получу, если куплю "Yes" на $100</div>

        <div class="stats-row">
            <div class="stat-box">
                <span class="stat-val" id="price-val">--</span>
                <span class="stat-lbl">Цена (Ask)</span>
            </div>
            <div class="stat-box">
                <span class="stat-val" id="chance-val">--</span>
                <span class="stat-lbl">Шанс</span>
            </div>
        </div>

        <div id="error-msg"></div>
    </div>

    <div class="version">v6.1 Final</div>

    <script>
        // --- КОНФИГУРАЦИЯ ---
        const SLUG = "russia-x-ukraine-ceasefire-in-2025";
        const MY_BET = 100;
        
        // Список прокси (если один упадет, сработает другой)
        const PROXY_LIST = [
            "https://api.allorigins.win/raw?url=%s", 
            "https://corsproxy.io/?%s",
            "https://thingproxy.freeboard.io/fetch/%s"
        ];
        
        const API_BASE = "https://gamma-api.polymarket.com";

        // Функция с тайм-аутом (чтобы не висело вечно)
        async function fetchWithTimeout(resource, options = {}) {
            const { timeout = 5000 } = options; 
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            const response = await fetch(resource, { ...options, signal: controller.signal });
            clearTimeout(id);
            return response;
        }

        // Умный перебор прокси
        async function robustFetch(targetUrl) {
            const statusEl = document.getElementById('top-status');
            const urlNoCache = targetUrl + "&_t=" + Date.now(); // Анти-кэш

            for (let i = 0; i < PROXY_LIST.length; i++) {
                const proxyTemplate = PROXY_LIST[i];
                const finalUrl = proxyTemplate.replace("%s", encodeURIComponent(urlNoCache));
                
                try {
                    statusEl.innerText = `Подключение (канал ${i+1})...`;
                    const resp = await fetchWithTimeout(finalUrl);
                    if (!resp.ok) throw new Error("Status " + resp.status);
                    return await resp.json();
                } catch (e) {
                    console.warn(`Канал ${i+1} не ответил, пробуем следующий...`);
                }
            }
            throw new Error("Нет связи с Polymarket (все прокси заняты)");
        }

        async function updateData() {
            const amountEl = document.getElementById('payout-amount');
            const priceEl = document.getElementById('price-val');
            const chanceEl = document.getElementById('chance-val');
            const statusEl = document.getElementById('top-status');
            const errorEl = document.getElementById('error-msg');

            try {
                // 1. Ищем ID события
                const eventUrl = `${API_BASE}/events?slug=${SLUG}`;
                const eventData = await robustFetch(eventUrl);
                
                if (!eventData || !eventData.length) throw new Error("Событие не найдено");
                const marketId = eventData[0].markets[0].id;

                // 2. Ищем данные рынка (Книга ордеров)
                const marketUrl = `${API_BASE}/markets/${marketId}`;
                const marketFull = await robustFetch(marketUrl);

                // 3. Парсим
                const outcomes = JSON.parse(marketFull.outcomes);
                const yesIndex = outcomes.indexOf("Yes");

                // Логика цены: BestAsk (реальная покупка) -> иначе OutcomePrice
                let buyPrice = null;
                if (marketFull.bestAsk && marketFull.bestAsk[yesIndex]) {
                    buyPrice = parseFloat(marketFull.bestAsk[yesIndex]);
                } else {
                    buyPrice = parseFloat(JSON.parse(marketFull.outcomePrices)[yesIndex]);
                }

                if (!buyPrice) throw new Error("Цена не определена");

                // 4. Считаем
                const payout = MY_BET / buyPrice;
                const priceCents = (buyPrice * 100).toFixed(1);
                const prob = Math.round(buyPrice * 100);

                // 5. Выводим
                amountEl.classList.remove('loading');
                amountEl.innerText = payout.toLocaleString('en-US', {
                    style: 'currency', currency: 'USD', maximumFractionDigits: 0 
                });
                
                priceEl.innerText = priceCents + "¢";
                chanceEl.innerText = prob + "%";
                
                const now = new Date();
                statusEl.innerText = "Обновлено: " + now.toLocaleTimeString();
                errorEl.style.display = 'none';

            } catch (err) {
                console.error(err);
                statusEl.innerText = "Сбой связи";
                errorEl.style.display = 'block';
                errorEl.innerText = err.message + ". Повтор через минуту...";
            }
        }

        // Старт
        updateData();
        setInterval(updateData, 60000);
    </script>
</body>
</html>
